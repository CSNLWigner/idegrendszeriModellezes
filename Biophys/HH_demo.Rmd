---
title: "Hodgkin-Huxley"
author: "Balazs B Ujfalussy"
date: "11/09/2017"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


In this program we will study biophysical basis of action potentials by simulating the Nobel price winner Hodgkin-Huxley model.

Before starting, you need to understand the following concepts: *driving force, ion channel, Nernst potential, depolarisation and hyperpolarisation* and be able to write the equation describing the current flowing through an ion channel (e.g., $I_\text{K}$). If you are not familiar with these concepts than go back and read the `ions_demo.Rmd`. 

Now we use the principle of *separation of time scales*: since ion concentrations do not change substantially on the time scale of the simulations, we will treat them as constants. Hence, the Nernst potential of the ions are also constants: $E_\text{K}=-77$mV and $E_\text{Na}=55$mV. We will aslo neglect the current generated by the K/Na pump.

We simulate the motion of the Na and K ions through the membrane of an idealised cell. The Na and the K ions move through separate ion channels. In the previous exercise we saw that the motion of the electrically charged ions through the membrane can change the membrane potential. We also observed that, when starting from an arbitrary initial condition, the membrane potential quickly reaches its equilibrium state defined by the Nernst potential of the ions $E_\text{K}$ and $E_\text{Na}$ and the permeability of the ion channels, $g_\text{K}$ and $g_\text{Na}$.

Now to make the system more realistic and also more interesting: the permeability of the ion channels, $g_\text{K}$ and $g_\text{Na}$ depends on the membrane potential. What does it mean? 

1. changes in the membrane potential incude changes in the premeabilities
2. this will change the ionic currents flowing through the membrane
3. and the currents will change the membrane potential, and so on.

Depending on the form of the voltage dependence of the conductances, there are two fundamental types of interactions: *positive feed-back* and *negative feed-back*.

Positive feed-back means that a initial small changes are *magnified* in a self reinforcing process: A small depolarisation opens the Na channels, more Na ions enter the cell and that leads to further *depolarisation*. This is the basis of instability and excitability.

Negative feed-back means that a initial small changes are *supressed* in a self inhibiting process: A small depolarisation opens the K channels, more K ions leaves the cell and that leads to further *hyperpolarisation*. This is the basis of stability and balance.

The essence of the Hodgkin-Huxley model is the interaction between positive and negative feed-back loops.

## 1. simulation with constant input

```{r, message=FALSE, warning=FALSE}
## first we load the file that defines the model and the parameters.
source('./HH_sim.R', chdir=T)
## We use the package [deSolve](http://desolve.r-forge.r-project.org) 
## to simulate the differential equations.
```

Constant current is injected to a neuron of 20 $\mu$m diameter with Na and K channels. We record the response for 50 ms. 

```{r}
I0 <- 1/10/1000 # change this to change the input current!
## meaningful range is between [-1/5, 1] / 1000

times <-  seq(0,50, by=0.02) # the time points for the simulation - in ms!
input <- cbind(times, rep(I0, length(times))) # set the input current, a matrix with two column: [time, current]
I.ext <- approxfun(input[,1], input[,2], method = "linear", rule = 2) # this is necessary to provide input for a the differential equation system
		
params <- c(gK=gK, gNa=gNa, gL=gL, cm=cm, E.Na=E.Na, E.K=E.K, E.L=E.L) # parameters of the system. 
# gK, gNa, gL: K, Na and leak maximal conductance in mS, 
# cm: membrane capacitance in uF
# E.K, E.Na, E.L: the reversal potential of the K, Na ions and the leak.
# For more details, see the demos/HH_consts.R file
state <- c(v=-65, m=.053, h=.596, n=.317) # initial state of the system
# v: membrane potential in mV
# m, h, n: the opening probability of the gates

out <- ode(y = state, times = times, func = sim.HH, parms = params) #ode is a function that simulates a system of Ordinary Differential Equations - see the documentation of the package deSolve
```
	
When we plot the response (membrane potential) of the cell as the function of time we can see that it responds to the constant current with repetitive action potential firing. You can also observe the evolution of the gate variables indicated with different colors.

```{r, echo=FALSE}

cols <- c(2,3,4)
#layout(matrix(c(1,2,3,4,6,5), 3), c(1,1), c(4, 2, 4))
par(mfcol=c(2,1))
par(mar=c(1,4,1,1))
plot(out[,1], out[,2], ylim=c(-80, 40), axes=F, xlab="", ylab="membrane potential (mV)", t="l"); axis(2, las=2)
#plot(out[,1], out[,6] * 1000, axes=F, xlab="", ylab="stimulus (nA)", t="l"); axis(2, las=2)

par(mar=c(4,4,1,1))
matplot(out[,1], out[,3:5], ylim=c(0, 1), axes=F, xlab="time (ms)", ylab="open probability", t="l", lty=1, col=cols); axis(2, las=2)
axis(1)
legend('topright', c('m-gate', 'h-gate', 'n-gate'), col=cols, lty=1, bty="n")
		
		
#par(mar=c(4,4,4,4))
#plot(out[,2], out[,3], pch=15, cex=0.3, axes=F, xlab="voltage (mV)", ylab="m-gate")
#axis(1); axis(2, las=2)

#plot(out[,2], out[,5], pch=15, cex=0.3, axes=F, xlab="voltage (mV)", ylab="h-gate")
#axis(1); axis(2, las=2)

```


### Homework

1. Change the injected current and find the minimal current that is required for continuous action potential firing! Does the shape of the action potential change depending with the input current? [2p]
2. How many positive and negative feed-back loop can you identify in this system? Recall, that the dynamical variables of the system are not the ion channel permeabilities but gates of the channels and the voltage! [2p]
3. What is the maximum amplitude of the action potential? Hint: what is the theoretically possible maximum of the peak voltage during an action potential? [2p]

## 2. simulation with a short current pulse

Next, short (2 ms) current pulse is injected in the same neuron.

```{r}
I0 <-  0 # the background current
delay <- 10 # the delay of the pulse in ms
I.stim <- 1/10 / 1000 # change this to set the amplitude of the pulse
## meaningful range is between [-1/5, 1] / 1000
times <-  seq(0,50, by=0.02) # # the time points for the simulation - in ms!
input <- cbind(times, rep(I0, length(times))) # input current
input <- set.input(delay, delay+2, I.stim, input) # this function adds a square pulse on the top of constant input
# we can add a second pulse using the same function
# input <- set.input(delay+8, delay+8+2, I.stim, input) 

						
I.ext <- approxfun(input[,1], input[,2], method = "linear", rule = 2) # input for the DE
params <- c(gK=gK, gNa=gNa, gL=gL, cm=cm, E.Na=E.Na, E.K=E.K, E.L=E.L) # parameters
# gK, gNa, gL: K, Na and leak maximal conductance in mS, 
# cm: membrane capacitance in uF
# E.K, E.Na, E.L: the reversal potential of the K, Na ions and the leak.
state <- c(v=-65, m=.053, h=.596, n=.317) # initial state
# v: membrane potential in mV
# m, h, n: the opening probability of the gates

out2 <- ode(y = state, times = times, func = sim.HH, parms = params) ## solving the system of diff. Eqs.
```

We plot the membrane potential and the input current in the function of time.

```{r, fig.width=4, fig.height=5, echo=FALSE}
layout(matrix(c(1,2), 2), 1, c(5, 3))
par(mar=c(1,4,1,1))
plot(out2[,1], out2[,2], ylim=c(-80, 40), axes=F, xlab="", ylab="membrane potential (mV)", t="l"); axis(2, las=2)
par(mar=c(4,4,1,1))
plot(out2[,1], out2[,6] * 1000, axes=F, xlab="time (ms)", ylab="stim (nA)", t="l"); axis(2, las=2)
axis(1)		
```


## Homework

4. Change the current pulse amplitude and find the AP threshold! Can you elicit action potential by injecting a short, negative current pulse? How could you explain this? [4p]

5. Add a second current pulse with a short delay (3-20ms) after the first. Explore the threshold: is it easier or harder to elicite a second action potential after the first? [4p]

6. In some neurons there are no voltage sensitive (delayed rectifier) potassium channels. (These neurons still have K channels, but their conductance does not depend on the membrane potential.) How the action potential looks like in those neurons? What might be the role the the delayed rectifier potassium channels? Simulate this, by setting the membrane conductance for the potassium to a constant (not voltage dependent) gK=3e-5 mS value and stimulate the cell with I=0.6 nA current of 2 ms duration. [6p]


