---
title: "Hodgkin-Huxley"
author: "Balazs B Ujfalussy"
date: "11/09/2017"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source('demos/HH_sim.R', chdir=T)
```

This is a demo for simulating simulating the Hodgkin-Huxley equations. There are two simulations in this demo:
1: constant current
2: current pulses

We use the package [deSolve](http://desolve.r-forge.r-project.org) to simulate the differential equations.

## 1. simulation with constant input

Constant current is injected in a neuron of 20 $\mu$m diameter with Hodgkin-Huxley channels. Try to change the injected current and find the AP threshold!

```{r}
I0 <- 1/20/1000 # change this to change the input current!
## meaningful range is between [-1/5, 1] / 1000

times <-  seq(0,50, by=0.02) # the time points for the simulation - in ms!
input <- cbind(times, rep(I0, length(times))) # set the input current, a matrix with two column: [time, current]
I.ext <- approxfun(input[,1], input[,2], method = "linear", rule = 2) # this is necessary to provide input for a the differential equation system
		
params <- c(gK=gK, gNa=gNa, gL=gL, cm=cm, E.Na=E.Na, E.K=E.K, E.L=E.L) # parameters of the system. 
# gK, gNa, gL: K, Na and leak maximal conductance in mS, 
# cm: membrane capacitance in uF
# E.K, E.Na, E.L: the reversal potential of the K, Na ions and the leak.
# For more details, see the demos/HH_consts.R file
state <- c(v=-65, m=.053, h=.596, n=.317) # initial state of the system
# v: membrane potential in mV
# m, h, n: the opening probability of the gates

out <- ode(y = state, times = times, func = sim.HH, parms = params) #ode is a function that simulates a system of Ordinary Differential Equations - see the documentation of the package deSolve
```
	
Now plot the results

```{r, echo=FALSE}

cols <- c(2,3,4)
layout(matrix(c(1,2,3,4,6,5), 3), c(1,1), c(4, 2, 4))
par(mar=c(1,4,1,1))
plot(out[,1], out[,2], ylim=c(-80, 40), axes=F, xlab="", ylab="membrane potential (mV)", t="l"); axis(2, las=2)
plot(out[,1], out[,6] * 1000, axes=F, xlab="", ylab="stimulus (nA)", t="l"); axis(2, las=2)

par(mar=c(4,4,1,1))
matplot(out[,1], out[,3:5], ylim=c(0, 1), axes=F, xlab="time (ms)", ylab="probability", t="l", lty=1, col=cols); axis(2, las=2)
axis(1)
legend('topright', c('m-gate', 'h-gate', 'n-gate'), col=cols, lty=1, bty="n")
		
		
par(mar=c(4,4,4,4))
plot(out[,2], out[,3], pch=15, cex=0.3, axes=F, xlab="voltage (mV)", ylab="m-gate")
axis(1); axis(2, las=2)

plot(out[,2], out[,5], pch=15, cex=0.3, axes=F, xlab="voltage (mV)", ylab="h-gate")
axis(1); axis(2, las=2)

```

## 2. simulation with a short current pulse

Short (2 ms) current pulse is injected in a neuron of 20 $\mu$m diameter with Hodgkin-Huxley Na and K channels. Try to change the current pulse amplitude and find the AP threshold! Try also negative currents, or trains of pulses!


```{r}
I0 <-  0 # the background current
delay <- 10 # the delay of the pulse in ms
I.stim <- 1/10 / 1000 # change this to set the amplitude of the pulse
## meaningful range is between [-1/5, 1] / 1000
times <-  seq(0,50, by=0.02) # # the time points for the simulation - in ms!
input <- cbind(times, rep(I0, length(times))) # input current
input <- set.input(delay, delay+2, I.stim, input) # this function adds a square pulse on the top of constant input
						
I.ext <- approxfun(input[,1], input[,2], method = "linear", rule = 2) # input for the DE
params <- c(gK=gK, gNa=gNa, gL=gL, cm=cm, E.Na=E.Na, E.K=E.K, E.L=E.L) # parameters
# gK, gNa, gL: K, Na and leak maximal conductance in mS, 
# cm: membrane capacitance in uF
# E.K, E.Na, E.L: the reversal potential of the K, Na ions and the leak.
state <- c(v=-65, m=.053, h=.596, n=.317) # initial state
# v: membrane potential in mV
# m, h, n: the opening probability of the gates

out2 <- ode(y = state, times = times, func = sim.HH, parms = params) ## solving the system of diff. Eqs.
```

Now plot the results...

```{r, echo=FALSE}
layout(matrix(c(1,2), 2), 1, c(5, 3))
par(mar=c(1,4,1,1))
plot(out2[,1], out2[,2], ylim=c(-80, 40), axes=F, xlab="", ylab="membrane potential (mV)", t="l"); axis(2, las=2)
par(mar=c(4,4,1,1))
plot(out2[,1], out2[,6] * 1000, axes=F, xlab="time (ms)", ylab="stim (nA)", t="l"); axis(2, las=2)
axis(1)		
```
